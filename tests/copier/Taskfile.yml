---
version: "3"

vars:
  TEST_TMP_DIR: '{{.USER_WORKING_DIR}}/tmp/tests/copier'
  TEST_PROJECT_NAME: 'generated-project'

tasks:
  default:
    desc: |
      ‚ÑπÔ∏è Description:
        Tests the copier copy functionality by copying from the current
        template to a temporary destination and verifying the existence
        of essential files.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
          Default: "./tmp/tests/copier"
        - TEST_PROJECT_NAME: Name of the test project
          Default: "generated-project"

      üîÑ Execution:
        1. Cleans up previous test directories
        2. Creates a test directory in tmp/tests/copier/
        3. Runs copier copy command to copy template to test directory
        4. Runs verification tests for the copied project

      üìù Usage:
        task test
    deps:
      - ::copier:install
      - cleanup
    cmds:
      # Create a simple temporary directory for this test
      - mkdir -p {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}

      # Run the copier copy command (using the local template)
      - task: ::copier
        vars:
          CLI_ARGS: copy {{.USER_WORKING_DIR}} --vcs-ref=HEAD {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}

      # Run verification tests
      - task: verify:copier-answers
      - task: verify:no-file
      - task: verify:no-directory
      - task: verify:commitizen-config
      - task: verify:helm-chart-name
      - task: verify:features-structure
      - task: verify:screenshots-structure
      - task: verify:step-definitions-structure
      - task: verify:entrypoint-content
      - task: verify:devsecops-task

  cleanup:
    desc: |
      ‚ÑπÔ∏è Description:
        Cleans up test directories created by the copier tests.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
          Default: "./tmp/tests/copier"
        - TEST_PROJECT_NAME: Name of the test project
          Default: "generated-project"

      üîÑ Execution:
        Removes the test directory from tmp/tests/copier/

      üìù Usage:
        task cleanup
    cmds:
      - rm -rf {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}
      - echo "‚úÖ [{{.TASK}}] Copier test directory has been cleaned up"


  verify:copier-answers:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies that the .copier-answers.yml file exists in the destination.
        This is a critical file that confirms the template was correctly copied.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        Checks for the existence of .config/devsecops/.copier-answers.yml

      üìù Usage:
        task verify:copier-answers
    cmds:
      - |
        if [ -f "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/.config/devsecops/.copier-answers.yml" ]; then
          echo "‚úÖ [{{.TASK}}] Test passed: .copier-answers.yml file exists in the destination"
        else
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: .copier-answers.yml file does not exist in the destination"
          exit 1
        fi

  verify:no-file:
    desc: Verifies that certain files do not exist in the generated project
    vars:
      FILES_TO_CHECK:
        - iac/environment/testing/superset-values.yaml
        - iac/helm/Chart.lock
        - tests/infra/kube/ansible/verify/superset_is_ready.yml
        - tests/infra/kube/ansible/verify/superset_login_page_check.yml
    cmds:
      - for:
          var: FILES_TO_CHECK
          as: FILE
        cmd: |
          if [ -f "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/{{.FILE}}" ]; then
            echo "‚ùå [{{.TASK}}]"
            echo "Failed: '{{.FILE}}' file exists in the generated project"
            echo "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/{{.FILE}}"
            exit 1
          fi
        silent: true
      - cmd: echo "‚úÖ [{{.TASK}}] All directory checks passed"
        silent: true

  verify:no-directory:
    desc: Verifies that certain directories do not exist in the generated project
    vars:
      DIRS_TO_CHECK:
        - .cache
        - .config/**/roles
        - .vscode
        - megalinter-reports
        - node_modules
        - tests/copier
        - tests/devcontainer
        - tests/e2e/codeceptjs/screenshots/diff
        - tmp
        - venv
    cmds:
      - for:
          var: DIRS_TO_CHECK
          as: DIR
        cmd: |
          if [ -d "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/{{.DIR}}" ]; then
            echo "‚ùå [{{.TASK}}]"
            echo "Failed: '{{.DIR}}' directory exists in the generated project"
            echo "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/{{.DIR}}"
            exit 1
          fi
        silent: true
      - cmd: echo "‚úÖ [{{.TASK}}] All directory checks passed"
        silent: true

  verify:devsecops-task:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies that a DevSecOps task can be executed in the generated project.
        This test ensures that the generated project is functional and properly
        configured with DevSecOps capabilities.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        Runs a simple DevSecOps task in the generated project and checks for success

      üìù Usage:
        task verify:devsecops-task
    cmds:
      - |
        echo "üîç Testing DevSecOps task execution in the generated project..."
        echo "üìÇ Working directory: {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}"

        # First, list available tasks to help with debugging
        echo "üìã Available tasks in the generated "
        cd {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}} && task --list | grep devsecops

      - |
        # Now try to execute the devsecops task
        echo "üöÄ Executing 'task devsecops'..."
        cd {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}
        time task test

  verify:commitizen-config:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies that the commitizen configuration file (cz.yaml) has the correct version
        and does not include '.gitlab-ci.yml' in the version_files list.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        Checks the cz.yaml file for specific configuration values

      üìù Usage:
        task verify:commitizen-config
    cmds:
      - |
        CZ_FILE="{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/.config/commitizen/cz.yaml"
        echo "üîç Checking commitizen configuration file: $CZ_FILE"

        # Check if the file exists
        if [ ! -f "$CZ_FILE" ]; then
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: commitizen configuration file does not exist"
          exit 1
        fi

        # Check version is 0.1.0
        VERSION=$(grep "version:" "$CZ_FILE" | grep -v "version_" | awk '{print $2}')
        if [ "$VERSION" != "0.1.0" ]; then
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: Expected version 0.1.0, but found $VERSION"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Version check passed: Found version 0.1.0"
        fi

        # Check that .gitlab-ci.yml is not in version_files
        if grep -A10 "version_files:" "$CZ_FILE" | grep -q "\.gitlab-ci\.yml"; then
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: .gitlab-ci.yml found in version_files"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] version_files check passed: .gitlab-ci.yml not found in version_files"
        fi

        echo "‚úÖ [{{.TASK}}] All commitizen configuration checks passed"

  verify:helm-chart-name:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies that the Helm Chart.yaml file has the correct project name.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        Checks the Chart.yaml file for the correct project name

      üìù Usage:
        task verify:helm-chart-name
    cmds:
      - |
        CHART_FILE="{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/iac/helm/Chart.yaml"
        echo "üîç Checking Helm Chart file: $CHART_FILE"

        # Check if the file exists
        if [ ! -f "$CHART_FILE" ]; then
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: Helm Chart file does not exist"
          exit 1
        fi

        # Check project name is 'generated-project'
        PROJECT_NAME=$(grep "^name:" "$CHART_FILE" | awk '{print $2}')
        if [ "$PROJECT_NAME" != "generated-project" ]; then
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: Expected project name 'generated-project', but found '$PROJECT_NAME'"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Project name check passed: Found 'generated-project'"
        fi

        echo "‚úÖ [{{.TASK}}] All Helm Chart name checks passed"

  verify:features-structure:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies the basic structure of the 'features' directory.
        Ensures 'features/' exists, but specific subdirectories/files like
        'features/authentication' are absent.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        1. Checks if 'features' directory exists.
        2. Checks if 'features/authentication' directory does NOT exist.
        3. Checks if 'features/authentication/admin_authentication.feature' file does NOT exist.

      üìù Usage:
        task verify:features-structure
    cmds:
      - |
        FEATURES_DIR="{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/features"
        AUTH_DIR="$FEATURES_DIR/authentication"
        AUTH_FILE="$AUTH_DIR/admin_authentication.feature"

        echo "üîç Verifying features directory structure..."

        # 1. Check if features directory exists
        if [ ! -d "$FEATURES_DIR" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'features' directory does not exist at $FEATURES_DIR"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'features' directory exists."
        fi

        # 2. Check if features/authentication directory does NOT exist
        if [ -d "$AUTH_DIR" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'features/authentication' directory exists at $AUTH_DIR"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'features/authentication' directory does not exist."
        fi

        # 3. Check if features/authentication/admin_authentication.feature file does NOT exist
        if [ -f "$AUTH_FILE" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'features/authentication/admin_authentication.feature' file exists at $AUTH_FILE"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'features/authentication/admin_authentication.feature' file does not exist."
        fi

        echo "‚úÖ [{{.TASK}}] All features structure checks passed."

  verify:screenshots-structure:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies the structure of the base screenshots directory.
        Ensures 'tests/e2e/codeceptjs/screenshots/base' exists, but specific
        test-generated screenshots like 'dashboard_after_login.png' are absent.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        1. Checks if 'tests/e2e/codeceptjs/screenshots/base' directory exists.
        2. Checks if 'tests/e2e/codeceptjs/screenshots/base/dashboard_after_login.png' file does NOT exist.

      üìù Usage:
        task verify:screenshots-structure
    cmds:
      - |
        BASE_SCREENSHOTS_DIR="{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/tests/e2e/codeceptjs/screenshots/base"
        LOGIN_SCREENSHOT_FILE="$BASE_SCREENSHOTS_DIR/dashboard_after_login.png"

        echo "üîç Verifying base screenshots directory structure..."

        # 1. Check if base screenshots directory exists
        if [ ! -d "$BASE_SCREENSHOTS_DIR" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'tests/e2e/codeceptjs/screenshots/base' directory does not exist at $BASE_SCREENSHOTS_DIR"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'tests/e2e/codeceptjs/screenshots/base' directory exists."
        fi

        # 2. Check if specific screenshot file does NOT exist
        if [ -f "$LOGIN_SCREENSHOT_FILE" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'dashboard_after_login.png' file exists in the base screenshots directory at $LOGIN_SCREENSHOT_FILE"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'dashboard_after_login.png' file does not exist in the base screenshots directory."
        fi

        echo "‚úÖ [{{.TASK}}] All base screenshots structure checks passed."

  verify:step-definitions-structure:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies the structure of the step definitions directory.
        Ensures 'entrypoint.js' exists and 'authentication.js' does not.

      üîß Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      üîÑ Execution:
        1. Checks if 'tests/e2e/codeceptjs/step_definitions/entrypoint.js' file exists.
        2. Checks if 'tests/e2e/codeceptjs/step_definitions/authentication.js' file does NOT exist.

      üìù Usage:
        task verify:step-definitions-structure
    cmds:
      - |
        STEP_DEFS_DIR="{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/tests/e2e/codeceptjs/step_definitions"
        ENTRYPOINT_FILE="$STEP_DEFS_DIR/entrypoint.js"
        AUTH_FILE="$STEP_DEFS_DIR/authentication.js"

        echo "üîç Verifying step definitions structure..."

        # 1. Check if entrypoint.js file exists
        if [ ! -f "$ENTRYPOINT_FILE" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'entrypoint.js' file does not exist at $ENTRYPOINT_FILE"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'entrypoint.js' file exists."
        fi

        # 2. Check if authentication.js file does NOT exist
        if [ -f "$AUTH_FILE" ]; then
          echo "‚ùå [{{.TASK}}] Failed: 'authentication.js' file exists at $AUTH_FILE"
          exit 1
        else
          echo "‚úÖ [{{.TASK}}] Check passed: 'authentication.js' file does not exist."
        fi

        echo "‚úÖ [{{.TASK}}] All step definitions structure checks passed."

  verify:entrypoint-content:
    desc: Verifies that tests/e2e/codeceptjs/step_definitions/entrypoint.js only contains expected comments.
    vars:
      ENTRYPOINT_FILE: "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/tests/e2e/codeceptjs/step_definitions/entrypoint.js"
      EXPECTED_CONTENT: |
        // Load step definitions from specific files
        // require('./domain_name.js')
    cmds:
      - |
        echo "üîç Verifying content of {{.ENTRYPOINT_FILE}}..."
        # Use process substitution and diff to compare file content with the expected string
        # Use tr -d '\r' to handle potential CRLF issues
        if diff -u <(echo -n "{{.EXPECTED_CONTENT}}") <(cat "{{.ENTRYPOINT_FILE}}" | tr -d '\r'); then
          echo "‚úÖ [{{.TASK}}] Test passed: {{.ENTRYPOINT_FILE}} content is correct."
        else
          echo "‚ùå [{{.TASK}}]"
          echo "Failed: {{.ENTRYPOINT_FILE}} content does not match expected comments."
          echo "Expected:"
          echo "{{.EXPECTED_CONTENT}}"
          echo "Actual:"
          cat "{{.ENTRYPOINT_FILE}}"
          exit 1
        fi
