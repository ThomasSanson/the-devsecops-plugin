---
version: "3"

vars:
  TEST_TMP_DIR: '{{.ROOT_DIR}}/tmp/tests/copier'
  ROOT_DIR: '{{.ROOT_DIR}}'
  TEST_PROJECT_NAME: 'generated-project'

tasks:
  default:
    desc: |
      ℹ️ Description:
        Tests the copier copy functionality by copying from the current
        template to a temporary destination and verifying the existence
        of essential files.

      🔧 Variables:
        - TEST_TMP_DIR: Temporary directory for test output
          Default: "./tmp/tests/copier"
        - TEST_PROJECT_NAME: Name of the test project
          Default: "generated-project"

      🔄 Execution:
        1. Cleans up previous test directories
        2. Creates a test directory in tmp/tests/copier/
        3. Runs copier copy command to copy template to test directory
        4. Runs verification tests for the copied project

      📝 Usage:
        task test
    deps:
      - ::copier:install
      - cleanup
    cmds:
      # Create a simple temporary directory for this test
      - mkdir -p {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}

      # Run the copier copy command (using the local template)
      - task: ::copier
        vars:
          CLI_ARGS: copy {{.ROOT_DIR}} --vcs-ref=HEAD {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}

      # Run verification tests
      - task: verify:copier-answers
      - task: verify:no-tests-directory
      - task: verify:devsecops-task

  cleanup:
    desc: |
      ℹ️ Description:
        Cleans up test directories created by the copier tests.

      🔧 Variables:
        - TEST_TMP_DIR: Temporary directory for test output
          Default: "./tmp/tests/copier"
        - TEST_PROJECT_NAME: Name of the test project
          Default: "generated-project"

      🔄 Execution:
        Removes the test directory from tmp/tests/copier/

      📝 Usage:
        task cleanup
    cmds:
      - rm -rf {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}
      - echo "✅ Copier test directory has been cleaned up"


  verify:copier-answers:
    desc: |
      ℹ️ Description:
        Verifies that the .copier-answers.yml file exists in the destination.
        This is a critical file that confirms the template was correctly copied.

      🔧 Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      🔄 Execution:
        Checks for the existence of .config/devsecops/.copier-answers.yml

      📝 Usage:
        task verify:copier-answers
    cmds:
      - |
        if [ -f "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/.config/devsecops/.copier-answers.yml" ]; then
          echo "✅ Test passed: .copier-answers.yml file exists in the destination"
        else
          echo "❌ Test failed: .copier-answers.yml file does not exist in the destination"
          exit 1
        fi

  verify:no-tests-directory:
    desc: |
      ℹ️ Description:
        Verifies that there is no 'tests/copier' directory in the generated project.
        This test ensures that the template is properly configured to exclude
        test directories from the generated project.

      🔧 Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      🔄 Execution:
        Checks that the tests/copier directory does not exist in the generated project

      📝 Usage:
        task verify:no-tests-directory
    cmds:
      - |
        if [ -d "{{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}/tests/copier" ]; then
          echo "❌ Test failed: 'tests/copier' directory exists in the generated project"
          echo "The 'tests/copier' directory should not be copied to the generated project"
          exit 1
        else
          echo "✅ Test passed: No 'tests/copier' directory exists in the generated project"
        fi

  verify:devsecops-task:
    desc: |
      ℹ️ Description:
        Verifies that a DevSecOps task can be executed in the generated project.
        This test ensures that the generated project is functional and properly
        configured with DevSecOps capabilities.

      🔧 Variables:
        - TEST_TMP_DIR: Temporary directory for test output
        - TEST_PROJECT_NAME: Name of the test project

      🔄 Execution:
        Runs a simple DevSecOps task in the generated project and checks for success

      📝 Usage:
        task verify:devsecops-task
    cmds:
      - |
        echo "🔍 Testing DevSecOps task execution in the generated project..."
        echo "📂 Working directory: {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}"

        # First, list available tasks to help with debugging
        echo "📋 Available tasks in the generated "
        cd {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}} && task --list | grep devsecops

      - |
        # Now try to execute the devsecops task
        echo "🚀 Executing 'task devsecops'..."
        cd {{.TEST_TMP_DIR}}/{{.TEST_PROJECT_NAME}}
        time task test