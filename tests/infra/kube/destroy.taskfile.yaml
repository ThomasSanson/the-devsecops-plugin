---
version: "3"

vars:
  TASK_TEST_INFRASTRUCTURE_DESTROY_CLUSTER_NAME: '{{.TASK_TEST_INFRASTRUCTURE_DESTROY_CLUSTER_NAME | default "${PWD##*/}"}}'
  TASK_TEST_INFRASTRUCTURE_DESTROY_KUBECONFIG_DIR: '{{.TASK_TEST_INFRASTRUCTURE_DESTROY_KUBECONFIG_DIR | default "iac/environment/testing"}}'
  TASK_TEST_INFRASTRUCTURE_DESTROY_KUBECONFIG_FILE: '{{.TASK_TEST_INFRASTRUCTURE_DESTROY_KUBECONFIG_DIR}}/kubeconfig.yaml'

tasks:
  default:
    desc: |
      ‚ÑπÔ∏è Description:
        Performs destroy operations in the following order:
        1. Removes k3d cluster
    cmds:
      - cmd: echo "üöÄ Starting destroy phase..."
        silent: true
      - task: k3d
      - cmd: echo "‚úÖ Destroy phase completed successfully."
        silent: true

  k3d:
    desc: |
      ‚ÑπÔ∏è Description:
        Deletes the k3d cluster if it exists

      üîß Variables:
        - TASK_TEST_INFRASTRUCTURE_DESTROY_CLUSTER_NAME: Name of the k3d cluster
        - TASK_TEST_INFRASTRUCTURE_DESTROY_KUBECONFIG_FILE: Path to kubeconfig file

      üîÑ Execution:
        1. Verifies cluster existence
        2. Deletes cluster
    status:
      - '! k3d cluster list | grep -q "{{.TASK_TEST_INFRASTRUCTURE_DESTROY_CLUSTER_NAME}}"'
    cmds:
      - k3d cluster delete {{.TASK_TEST_INFRASTRUCTURE_DESTROY_CLUSTER_NAME}}
