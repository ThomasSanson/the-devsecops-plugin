---
- name: Verify Sealed Secrets Controller Deployment
  hosts: localhost # DevSkim: ignore DS162092 # Debug context restricted to development environments
  gather_facts: false

  vars:
    kubeconfig: "{{ playbook_dir }}/../../../../../iac/environment/testing/kubeconfig.yaml"
    sealed_secrets_namespace: kube-system # checkov:skip=CKV_SECRET_6:This testing environment requires clear-text secrets for developer debugging purposes
    controller_name: sealed-secrets

  tasks:
    - name: Verify Sealed Secrets deployment exists
      kubernetes.core.k8s_info:
        kind: Deployment
        name: "{{ controller_name }}"
        namespace: "{{ sealed_secrets_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: sealed_secrets_deployment
      failed_when: sealed_secrets_deployment.resources | length == 0

    - name: Get Sealed Secrets controller pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ sealed_secrets_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        label_selectors:
          - app.kubernetes.io/name=sealed-secrets
      register: sealed_secrets_pods

    - name: Verify Sealed Secrets pods exist and are running
      ansible.builtin.fail:
        msg: "No running Sealed Secrets controller pods found"
      when: sealed_secrets_pods.resources | length == 0

    - name: Verify Sealed Secrets service exists
      kubernetes.core.k8s_info:
        kind: Service
        name: "{{ controller_name }}"
        namespace: "{{ sealed_secrets_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: sealed_secrets_service
      failed_when: sealed_secrets_service.resources | length == 0
