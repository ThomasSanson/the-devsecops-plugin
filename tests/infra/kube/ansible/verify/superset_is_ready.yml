---
- name: Verify Apache Superset Deployment
  hosts: localhost # DevSkim: ignore DS162092 # Debug context restricted to development environments
  gather_facts: false

  vars:
    kubeconfig: "{{ playbook_dir }}/../../../../../iac/environment/testing/kubeconfig.yaml"
    superset_namespace: superset # checkov:skip=CKV_SECRET_6:This testing environment requires clear-text secrets for developer debugging purposes
    release_name: superset

  tasks:
    - name: Verify Superset deployment exists
      kubernetes.core.k8s_info:
        kind: Deployment
        name: "{{ release_name }}"
        namespace: "{{ superset_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      register: superset_deployment
      failed_when: superset_deployment.resources | length == 0

    - name: Check Superset pods are running
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ superset_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        label_selectors:
          - app.kubernetes.io/instance={{ release_name }}
      register: superset_pods
      failed_when: superset_pods.resources | length == 0

    - name: Display Superset pod status
      ansible.builtin.debug:
        msg: "Superset is running with {{ superset_pods.resources | length }} pods"
