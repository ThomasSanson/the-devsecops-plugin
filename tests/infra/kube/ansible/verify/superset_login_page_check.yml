---
- name: Verify Apache Superset Login Page Content
  hosts: localhost # DevSkim: ignore DS162092 # Debug context restricted to development environments
  gather_facts: false

  vars:
    kubeconfig: "{{ playbook_dir }}/../../../../../iac/environment/testing/kubeconfig.yaml"
    superset_namespace: superset # checkov:skip=CKV_SECRET_6:This testing environment requires clear-text secrets for developer debugging purposes
    release_name: superset
    login_text_to_check: "Enter your login and password below:"
    url_to_test: http://localhost:8088/login/ # DevSkim: ignore DS162092 # Debug context restricted to development environments

  tasks:
    - name: Check Superset login page content with kubectl exec and grep
      ansible.builtin.shell: >
        kubectl --kubeconfig {{ kubeconfig }} exec -n {{ superset_namespace }}
        $(kubectl --kubeconfig {{ kubeconfig }} get pods -n {{ superset_namespace }} -l app={{ release_name }} -o name | head -1)
        -- curl -s {{ url_to_check }} | grep "{{ login_text_to_check }}"
      register: login_check_result
      changed_when: false
      # On ne veut pas que le playbook échoue si grep ne trouve pas le texte
      ignore_errors: true

    - name: Verify login text was found
      ansible.builtin.assert:
        that: login_check_result.rc == 0
        fail_msg: "The expected text '{{ login_text_to_check }}' was not found in the login page"
        success_msg: "Successfully verified that the login page contains '{{ login_text_to_check }}'"

    - name: Display verification result
      ansible.builtin.debug:
        msg: "✅ Superset login page verification successful: Found '{{ login_text_to_check }}' in the login page"
      when: login_check_result.rc == 0
