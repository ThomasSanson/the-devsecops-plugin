---
- name: Disrupt Sealed Secrets Controller to Test Resilience
  hosts: localhost # DevSkim: ignore DS162092 # Debug context restricted to development environments
  gather_facts: false

  vars:
    kubeconfig: "{{ playbook_dir }}/../../../../../iac/environment/testing/kubeconfig.yaml"
    sealed_secrets_namespace: kube-system # checkov:skip=CKV_SECRET_6:This testing environment requires clear-text secrets for developer debugging purposes
    controller_name: sealed-secrets

  tasks:
    - name: Get Sealed Secrets controller pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ sealed_secrets_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
        label_selectors:
          - app.kubernetes.io/name=sealed-secrets
      register: sealed_secrets_pods

    - name: Verify Sealed Secrets pods exist before disruption
      ansible.builtin.fail:
        msg: "No running Sealed Secrets controller pods found to disrupt"
      when: sealed_secrets_pods.resources | length == 0

    - name: Store pod name for disruption
      ansible.builtin.set_fact:
        target_pod: "{{ sealed_secrets_pods.resources[0].metadata.name }}"
      when: sealed_secrets_pods.resources | length > 0

    - name: Log the pod being disrupted
      ansible.builtin.debug:
        msg: "‚ö†Ô∏è Disrupting Sealed Secrets controller pod: {{ target_pod }}"

    - name: Delete the Sealed Secrets controller pod to test resilience
      kubernetes.core.k8s:
        state: absent
        kind: Pod
        name: "{{ target_pod }}"
        namespace: "{{ sealed_secrets_namespace }}"
        kubeconfig: "{{ kubeconfig }}"
      when: target_pod is defined

    - name: Log disruption action
      ansible.builtin.debug:
        msg: "üî• Sealed Secrets controller pod {{ target_pod }} has been deleted to test resilience. Kubernetes should automatically recreate it."
      when: target_pod is defined
