---
version: "3"

vars:
  TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR: '{{.OVERRIDE_TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR | default "iac/environment/testing"}}'
  TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_FILE: '{{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR}}/kubeconfig.yaml'

tasks:
  default:
    desc: |
      â„¹ï¸ Description:
        Performs cleanup operations in the following order:
        1. Removes kubeconfig files
        2. Removes sealed secrets files
        3. Removes Helm chart archives
    cmds:
      - cmd: echo "ðŸš€ Starting cleanup phase..."
        silent: true
      - task: kubeconfig
      - task: sealed-secrets
      - task: helm
      - cmd: echo "âœ… Cleanup phase completed successfully."
        silent: true

  kubeconfig:
    desc: |
      â„¹ï¸ Description:
        Removes the kubeconfig file if it exists

      ðŸ”§ Variables:
        - TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_FILE: Path to kubeconfig file
    status:
      - test ! -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_FILE}}
    cmds:
      - cmd: echo "ðŸ”„ Removing kubeconfig file..."
        silent: true
      - rm -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_FILE}}
      - cmd: echo "âœ… Kubeconfig file removed."
        silent: true

  sealed-secrets:
    desc: |
      â„¹ï¸ Description:
        Removes sealed secrets files from the environment directory

      ðŸ”§ Variables:
        - TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR: Environment directory containing sealed secrets
    status:
      - test ! -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR}}/sealed-secrets.yaml
      - test ! -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR}}/.secrets.hash
    cmds:
      - cmd: echo "ðŸ”„ Removing sealed secrets files..."
        silent: true
      - rm -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR}}/sealed-secrets.yaml
      - rm -f {{.TASK_TEST_INFRASTRUCTURE_CLEANUP_KUBECONFIG_DIR}}/.secrets.hash
      - cmd: echo "âœ… Sealed secrets files removed."
        silent: true

  helm:
    desc: |
      â„¹ï¸ Description:
        Removes downloaded Helm chart archives (*.tgz files)

      ðŸ”§ Variables:
        None - Removes all .tgz files from iac/helm directory
    status:
      - test -z "$(find iac/helm -name '*.tgz' 2>/dev/null)"
    cmds:
      - cmd: echo "ðŸ”„ Removing Helm chart archives..."
        silent: true
      - rm -f iac/helm/**/*.tgz
      - cmd: echo "âœ… Helm chart archives removed."
        silent: true
