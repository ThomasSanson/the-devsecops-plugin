---
version: "3"

vars:
  TASK_BUN_ENABLED: '{{.TASK_BUN_ENABLED | default "true"}}'

tasks:
  install:
    desc: Install Bun JavaScript runtime.
    summary: |
      â„¹ï¸ Description:
        Installs Bun, a fast all-in-one JavaScript runtime, ensuring the correct version
        to provide a consistent development environment.

      ğŸ”§ Variables:
        TASK_BUN_VERSION: The version of Bun to install (default: latest)

      ğŸ” Preconditions:
        - unzip must be installed.

      ğŸ”„ Execution:
        Executes the Bun installation script with the specified version.

      ğŸ“ Note:
        This task establishes a Bun environment, providing a foundation for JavaScript
        development without the need for Node.js. It is designed to be flexible,
        accommodating various project configurations and Linux distributions.
    vars:
      TASK_BUN_VERSION: '{{.TASK_BUN_VERSION | default "latest"}}'
    status:
      - command -v $HOME/.bun/bin/bun &> /dev/null
      - command -v $HOME/.bun/bin/bunx &> /dev/null
    preconditions:
      - sh: "command -v unzip &> /dev/null"
        msg: "âŒ unzip is not installed. Please install unzip and try again."
    cmds:
      - cmd: echo "ğŸ”„ Installing Bun runtime"
        silent: true
      - |
        if [[ {{OS}} == 'linux' ]]; then
          curl -fsSL https://bun.sh/install | bash
        elif [[ {{OS}} == 'darwin' ]]; then
          brew tap oven-sh/bun
          brew install bun
        else
          echo 'âŒ Unsupported operating system. Please install Bun manually.'
          exit 1
        fi
      - task: configure-bashrc
      - |
        export BUN_INSTALL="$HOME/.bun"
        export PATH=$BUN_INSTALL/bin:$PATH
        bun --version
      - cmd: echo 'ğŸ‰ Bun has been installed successfully.'
        silent: true

  configure-bashrc:
    desc: Set up Bun environment in .bashrc.
    summary: |
      â„¹ï¸ Description:
        Configures .bashrc to include Bun in the PATH, ensuring a single, correct configuration.
        Also cleans up excessive empty lines in the .bashrc file.

      ğŸ”§ Variables: none

      ğŸ” Preconditions: none

      ğŸ”„ Execution:
        Removes any existing Bun configurations from .bashrc, adds a single, correct configuration,
        and removes excessive empty lines.

      ğŸ“ Note:
        This task ensures that Bun is correctly configured in .bashrc without duplicates
        and maintains a clean file structure with at most one empty line between entries.
    cmds:
      - cmd: echo "ğŸ”„ Configuring Bun in .bashrc"
        silent: true
      - |
        # Remove any existing Bun configurations
        sed -i '/# bun/d' ~/.bashrc
        sed -i '/export BUN_INSTALL/d' ~/.bashrc
        sed -i '/export PATH=\$BUN_INSTALL/d' ~/.bashrc
      - |
        # Add a single, correct Bun configuration
        echo -e "\n# bun" >> ~/.bashrc
        echo 'export BUN_INSTALL="$HOME/.bun"' >> ~/.bashrc
        echo 'export PATH=$BUN_INSTALL/bin:$PATH' >> ~/.bashrc
      - |
        # Clean up excessive empty lines (more than one consecutive empty line)
        sed -i '/^$/N;/^\n$/D' ~/.bashrc
      - |
        # Ensure there's exactly one newline at the end of the file
        sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' ~/.bashrc
      - cmd: echo 'ğŸ‰ Bun .bashrc configuration updated successfully.'
        silent: true

  uninstall:
    desc: Remove Bun from the system.
    summary: |
      â„¹ï¸ Description:
        Uninstalls Bun and removes all related configurations.

      ğŸ”§ Variables: none

      ğŸ” Preconditions: none

      ğŸ”„ Execution:
        Removes Bun installation directory and related configurations from .bashrc.

      ğŸ“ Note:
        This task completely removes Bun from your system, including all configurations.
        Use with caution as this action cannot be undone.
    prompt: |
      âš ï¸  Warning: This will completely remove Bun from your system.
      Are you sure you want to continue? This action cannot be undone.
    cmds:
      - cmd: echo "ğŸ”„ Uninstalling Bun and cleaning configuration"
        silent: true
      - rm -rf ~/.bun
      - |
        # Remove any existing Bun configurations
        sed -i '/# bun/d' ~/.bashrc
        sed -i '/export BUN_INSTALL/d' ~/.bashrc
        sed -i '/export PATH=\$BUN_INSTALL/d' ~/.bashrc
      - |
        # Clean up excessive empty lines
        sed -i '/^$/N;/^\n$/D' ~/.bashrc
      - |
        # Ensure there's exactly one newline at the end of the file
        sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' ~/.bashrc
      - cmd: echo 'ğŸ‰ Bun has been uninstalled and configuration cleaned.'
        silent: true
