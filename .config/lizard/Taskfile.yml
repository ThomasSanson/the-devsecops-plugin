---
version: "3"

vars:
  TASK_LIZARD_ENABLED: '{{.TASK_LIZARD_ENABLED | default "true"}}'
  TASK_LIZARD_CLI_OPTS: '{{.TASK_LIZARD_CLI_OPTS | default ""}}'
  TASK_LIZARD_COMMAND: '{{.TASK_LIZARD_COMMAND | default "./venv/lizard/bin/lizard"}}'
  TASK_LIZARD_PATH_TO_ANALYSE: '{{.TASK_LIZARD_PATH_TO_ANALYSE | default "."}}'
  TASK_LIZARD_PYTHON_VERSION_FILE: '{{.TASK_LIZARD_PYTHON_VERSION_FILE | default ".config/python/.python-version"}}'
  TASK_LIZARD_REQUIREMENTS_FILE: '{{.TASK_LIZARD_REQUIREMENTS_FILE | default ".config/lizard/requirements.txt"}}'
  TASK_LIZARD_VIRTUALENV: '{{.TASK_LIZARD_VIRTUALENV | default "./venv/lizard"}}'

tasks:
  default:
    deps: [install]
    desc: Analyze code complexity with Lizard.
    summary: |
      â„¹ï¸ Description:
        Executes Lizard to analyse code complexity and maintainability.

      ğŸ”§ Variables:
        - TASK_LIZARD_VIRTUALENV: Virtual environment path
        - TASK_LIZARD_COMMAND: Lizard execution command
        - TASK_LIZARD_CLI_OPTS: Command-line options for Lizard
        - TASK_LIZARD_PATH_TO_ANALYSE: Path to analyse

      ğŸ” Preconditions:
        - 'install' task must be completed successfully
        - Lizard configuration file must exist

      ğŸ”„ Execution:
        Runs Lizard with specified options on designated files

      ğŸ“ Note:
        Execute after code modifications to maintain quality standards
    status:
      - test "{{.TASK_LIZARD_ENABLED}}" = "false"
    cmds:
      - cmd: echo "ğŸ”„ Starting lizard analysis phase"
        silent: true
      - |
        {{.TASK_LIZARD_COMMAND}} $(grep -v '^#' .gitignore | grep -v '^$' | awk '{if ($0 ~ /\./) print "-x"$0; else print "-x./"$0"/*"}' | tr '\n' ' ') {{.TASK_LIZARD_CLI_OPTS}} {{.TASK_LIZARD_PATH_TO_ANALYSE}}
      - cmd: echo "ğŸ‰ Lizard analysis phase completed successfully"
        silent: true

  install:
    desc: Set up Lizard in a virtual environment.
    summary: |
      â„¹ï¸ Description:
        Sets up Lizard and its dependencies in a virtual environment.

      ğŸ”§ Variables:
        - TASK_LIZARD_PYTHON_VERSION_FILE: Python version file path
        - TASK_LIZARD_REQUIREMENTS_FILE: Requirements file path
        - TASK_LIZARD_VIRTUALENV: Virtual environment location

      ğŸ” Preconditions:
        - Python version file must exist
        - Active internet connection required

      ğŸ”„ Execution:
        1. Creates Python virtual environment
        2. Installs Lizard and dependencies
        3. Verifies installation

      ğŸ“ Note:
        Ensure Python version is compatible with Lizard
    preconditions:
      - sh: test -f {{.TASK_LIZARD_PYTHON_VERSION_FILE}}
        msg: |
          âŒ Error: missing file {{.TASK_LIZARD_PYTHON_VERSION_FILE}}.
          Please create it as follows:
          ```bash
          mkdir -p $(dirname "{{.TASK_LIZARD_PYTHON_VERSION_FILE}}")
          echo "3.11" > {{.TASK_LIZARD_PYTHON_VERSION_FILE}}
          ```
    status:
      - |
        {{.TASK_LIZARD_COMMAND}} --version | grep -q $(awk -F '==' '{print $2}' {{.TASK_LIZARD_REQUIREMENTS_FILE}})
    cmds:
      - cmd: echo "ğŸ”„ Starting install phase"
        silent: true
      - python$(cut -d '=' -f 2 {{.TASK_LIZARD_PYTHON_VERSION_FILE}}) -m venv {{.TASK_LIZARD_VIRTUALENV}}
      - "{{.TASK_LIZARD_VIRTUALENV}}/bin/pip install -r {{.TASK_LIZARD_REQUIREMENTS_FILE}}"
      - cmd: echo "ğŸ‰ Install phase completed successfully"
        silent: true

  uninstall:
    desc: Remove Lizard and clean up.
    summary: |
      â„¹ï¸ Description:
        Removes temporary files and cleans up the environment after Lizard execution.

      ğŸ”§ Variables: None

      ğŸ” Preconditions: None

      ğŸ”„ Execution:
        Removes temporary files and directories created during Lizard analysis

      ğŸ“ Note:
        This task is typically called via defer in other tasks
    cmds:
      - cmd: echo "ğŸ”„ Starting uninstall phase"
        silent: true
      - rm -rf {{.TASK_LIZARD_VIRTUALENV}}
      - cmd: echo "ğŸ‰ Uninstall phase completed successfully"
        silent: true
