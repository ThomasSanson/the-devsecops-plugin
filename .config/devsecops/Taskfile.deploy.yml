---
version: "3"

vars:
  TASK_DEVSECOPS_DEPLOY_ENABLED: '{{.OVERRIDE_TASK_DEVSECOPS_DEPLOY_ENABLED | default "true"}}'

tasks:
  default:
    desc: Run all generic deploy tasks
    status:
      - test "{{.TASK_DEVSECOPS_DEPLOY_ENABLED}}" = "false"
    cmds:
      - task: check-testing-environment
      - task: bootstrap

  bootstrap:
    desc: |
      ℹ️ Description:
        Prepares the infrastructure with required components
    cmds:
      - task: :helm:dependency:update
      - task: :helm:build
      - task: :sealed-secrets:install
      - task: :kubeseal:seal

  check-testing-environment:
    internal: true
    desc: Check if any of the KUBECONFIG variables contain "testing" and run TDD tests if so
    status:
      - test -n "$KUBECONFIG" && test -f "$KUBECONFIG"
    cmds:
      - task: :test:infrastructure:dependency
      - task: :test:infrastructure:create
