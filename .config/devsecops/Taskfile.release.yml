---
version: "3"

vars:
  TASK_DEVSECOPS_RELEASE_ENABLED: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_ENABLED | default "true"}}'
  TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH | default "main"}}'
  TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH | default ""}}'

tasks:
  default:
    desc: Run all generic release tasks
    status:
      - test "{{.TASK_DEVSECOPS_RELEASE_ENABLED}}" = "false"
    cmds:
      - task: commitizen

  commitizen:
    status:
      - test "{{.TASK_COMMITIZEN_ENABLED}}" = "false"
    cmds:
      - task: :commitizen:bump
        vars:
          TASK_COMMITIZEN_BUMP_YES: "true"
          TASK_COMMITIZEN_BUMP_CHANGELOG:
            sh: |
                if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
                  echo "true"
                  exit 0
                fi
                echo "false"
          TASK_COMMITIZEN_BUMP_DRY_RUN:
            sh: |
                if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
                  echo "false"
                  exit 0
                fi
                echo "true"
