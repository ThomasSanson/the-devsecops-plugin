---
version: "3"

vars:
  TASK_DEVSECOPS_RELEASE_ENABLED: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_ENABLED | default "true"}}'
  TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH | default "main"}}'
  TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH | default ""}}'

tasks:
  default:
    desc: Run all generic release tasks
    status:
      - test "{{.TASK_DEVSECOPS_RELEASE_ENABLED}}" = "false"
    cmds:
      - cmd: |
          if [[ "{{.TASK_COMMITIZEN_ENABLED}}" == "true" ]]; then
            echo "üì¶ Running commitizen bump for release..."

            export OVERRIDE_TASK_COMMITIZEN_BUMP_YES="true"
            export OVERRIDE_TASK_COMMITIZEN_BUMP_DRY_RUN="true"

            # Configure Commitizen variables for default branch
            if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
              export OVERRIDE_TASK_COMMITIZEN_BUMP_CHANGELOG="true"
              export OVERRIDE_TASK_COMMITIZEN_BUMP_DRY_RUN="false"
            fi

            task {{.TASK_FLAGS}} commitizen:bump
            echo "{{.TASK_SEPARATOR}}"
          else
            echo "‚ö†Ô∏è Skipping commitizen bump (disabled via TASK_COMMITIZEN_ENABLED=false)"
          fi
        silent: true
      - cmd: |
          if [[ "{{.TASK_KANIKO_ENABLED}}" == "true" ]]; then
            echo "üöÄ Running Kaniko image push Version..."

            export OVERRIDE_TASK_KANIKO_PUSH="true"

            # Read version from VERSION file
            if [ -f "VERSION" ]; then
              export OVERRIDE_TASK_KANIKO_IMAGE_TAG=$(cat VERSION)
            fi

            task kaniko
          else
            echo "‚ö†Ô∏è Skipping Kaniko push (disabled via TASK_KANIKO_ENABLED=false)"
          fi
        silent: true
      - cmd: |
          if [[ "{{.TASK_DOCKER_CE_ENABLED}}" == "true" ]]; then
            echo "üê≥ Running Docker CE build and push..."

            export OVERRIDE_TASK_DOCKER_CE_PUSH="true"

            # Read version from VERSION file
            if [ -f "VERSION" ]; then
              export OVERRIDE_TASK_DOCKER_CE_IMAGE_TAG=$(cat VERSION)
            fi

            task docker-ce:build
            task docker-ce:push
          else
            echo "‚ö†Ô∏è Skipping Docker CE push (disabled via TASK_DOCKER_CE_ENABLED=false)"
          fi
        silent: true
