---
version: "3"

vars:
  TASK_DEVSECOPS_RELEASE_ENABLED: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_ENABLED | default "true"}}'
  TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH | default "main"}}'
  TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH: '{{.OVERRIDE_TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH | default ""}}'

tasks:
  default:
    desc: Run all generic release tasks
    status:
      - test "{{.TASK_DEVSECOPS_RELEASE_ENABLED}}" = "false"
    cmds:
      - task: commitizen
      - task: kaniko
      - task: docker

  commitizen:
    status:
      - test "{{.TASK_COMMITIZEN_ENABLED}}" = "false"
    cmds:
      - task: :commitizen:bump
        vars:
          TASK_COMMITIZEN_BUMP_YES: "true"
          TASK_COMMITIZEN_BUMP_CHANGELOG:
            sh: |
                if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
                  echo "true"
                  exit 0
                fi
                echo "false"
          TASK_COMMITIZEN_BUMP_DRY_RUN:
            sh: |
                if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
                  echo "false"
                  exit 0
                fi
                echo "true"

  kaniko:
    internal: true
    status:
      - test "{{.TASK_KANIKO_ENABLED}}" = "false"
    cmds:
      - task: :kaniko
        vars:
          TASK_KANIKO_PUSH: "true"
          TASK_KANIKO_IMAGE_TAG:
            sh: |
                if [ -f "VERSION" ]; then
                  echo $(cat VERSION)
                fi

  docker:
    internal: true
    status:
      - test "{{.TASK_DOCKER_CE_ENABLED}}" = "false"
    cmds:
      - task: :docker-ce:build
        vars:
          TASK_DOCKER_CE_IMAGE_TAG:
            sh: |
                if [ -f "VERSION" ]; then
                  echo $(cat VERSION)
                fi
      - task: :docker-ce:push
        vars:
          TASK_DOCKER_CE_PUSH:
            sh: |
                if [[ "{{.TASK_DEVSECOPS_RELEASE_CURRENT_BRANCH}}" == "{{.TASK_DEVSECOPS_RELEASE_DEFAULT_BRANCH}}" ]]; then
                  echo "true"
                  exit 0
                fi
                echo "false"
          TASK_DOCKER_CE_IMAGE_TAG:
            sh: |
                if [ -f "VERSION" ]; then
                  echo $(cat VERSION)
                fi
