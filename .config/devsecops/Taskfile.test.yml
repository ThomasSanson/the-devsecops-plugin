---
version: "3"

vars:
  TASK_DEVSECOPS_TEST_ENABLED: '{{.TASK_DEVSECOPS_TEST_ENABLED | default "true"}}'
  TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV: '{{.TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV | default "./venv/ansible"}}'
  TASK_DEVSECOPS_TEST_KUBECONFIG_DIR: '{{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR | default "iac/environment/testing"}}'
  TASK_DEVSECOPS_TEST_KUBECONFIG_FILE: '{{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR}}/kubeconfig.yaml'
  TASK_DEVSECOPS_TEST_DESTROY_ENABLED: '{{.TASK_DEVSECOPS_TEST_DESTROY_ENABLED | default "true"}}'
  TASK_DEVSECOPS_TEST_CLEANUP_ENABLED: '{{.TASK_DEVSECOPS_TEST_CLEANUP_ENABLED | default "true"}}'

tasks:
  default:
    desc: Run all tests tasks
    status:
      - test "{{.TASK_DEVSECOPS_TEST_ENABLED}}" = "false"
    cmds:
      - cmd: echo "ğŸ”„ Starting test phase"
        silent: true
      - task: bootstrap:infrastructure
      - task: :project:test
      - task: validate:resilience
      - task: teardown:infrastructure
      - cmd: echo "ğŸ‰ Test phase completed successfully"
        silent: true

  tdd:
    desc: Run all tdd tests tasks
    status:
      - test "{{.TASK_DEVSECOPS_TEST_ENABLED}}" = "false"
    cmds:
      - cmd: echo "ğŸ”„ Starting tdd phase"
        silent: true
      - task: bootstrap:infrastructure
        vars:
          TASK_DEVSECOPS_TEST_DESTROY_ENABLED: 'false'
          TASK_DEVSECOPS_TEST_CLEANUP_ENABLED: 'false'
      - task: :project:test:tdd
      - task: verify
      - cmd: echo "ğŸ‰ Tdd phase completed successfully"
        silent: true

  bootstrap:infrastructure:
    desc: |
      â„¹ï¸ Description:
        Bootstraps the test infrastructure by running the preparation tasks
        in the correct order
    cmds:
      - cmd: echo "ğŸ”„ Starting infrastructure bootstrap phase"
        silent: true
      - task: dependency
      - task: destroy
        vars:
          TASK_DEVSECOPS_TEST_DESTROY_ENABLED: '{{.TASK_DEVSECOPS_TEST_DESTROY_ENABLED}}'
      - task: cleanup
        vars:
          TASK_DEVSECOPS_TEST_CLEANUP_ENABLED: '{{.TASK_DEVSECOPS_TEST_CLEANUP_ENABLED}}'
      - task: syntax
      - task: create
      - task: prepare
      - cmd: echo "ğŸ‰ Infrastructure bootstrap phase completed successfully"
        silent: true

  teardown:infrastructure:
    desc: |
      â„¹ï¸ Description:
        Tears down and cleans up the test infrastructure
    cmds:
      - cmd: echo "ğŸ”„ Starting infrastructure teardown phase"
        silent: true
      - task: destroy
      - task: cleanup
      - cmd: echo "ğŸ‰ Infrastructure teardown phase completed successfully"
        silent: true

  destroy:
    desc: |
      â„¹ï¸ Description:
        Destroys the test infrastructure
    status:
      - test "{{.TASK_DEVSECOPS_TEST_DESTROY_ENABLED}}" = "false"
    cmds:
      - cmd: echo "ğŸ”„ Starting destroy phase"
        silent: true
      - task: :k3d:destroy:cluster
      - cmd: echo "ğŸ‰ Destroy phase completed successfully"
        silent: true

  dependency:
    desc: Verify and install required dependencies tools for testing
    cmds:
      - cmd: echo "ğŸ”„ Starting dependency phase"
        silent: true
      # Install Ansible and its dependencies first
      - task: :ansible:install
      # Verify Go installation
      - task: :go:install
      # Verify kubectl installation
      - task: :kubectl:install
      # Verify k3d installation
      - task: :k3d:install
      # Verify kubeseal installation
      - task: :kubeseal:install
      # Verify helm installation
      - task: :helm:install
      # Install infrastructure test collections
      - task: :ansible:galaxy:collection:install
        vars:
          TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE: tests/infra/kube/ansible/requirements.yml
      - cmd: echo "ğŸ‰ Dependency phase completed successfully"
        silent: true

  cleanup:
    desc: |
      â„¹ï¸ Description:
        Performs cleanup operations in the following order:
        1. Removes kubeconfig files
        2. Removes sealed secrets files
        3. Removes Helm chart archives
    cmds:
      - cmd: echo "ğŸ”„ Starting cleanup phase"
        silent: true
      - task: cleanup:kubeconfig
      - task: cleanup:sealed-secrets
      - task: cleanup:helm
      - cmd: echo "ğŸ‰ Cleanup phase completed successfully"
        silent: true

  cleanup:kubeconfig:
    desc: |
      â„¹ï¸ Description:
        Removes the kubeconfig file if it exists

      ğŸ”§ Variables:
        - TASK_DEVSECOPS_TEST_KUBECONFIG_FILE: Path to kubeconfig file
    status:
      - test ! -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_FILE}}
    cmds:
      - cmd: echo "ğŸ”„ Starting kubeconfig cleanup"
        silent: true
      - rm -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_FILE}}
      - cmd: echo "ğŸ‰ Kubeconfig cleanup completed successfully"
        silent: true

  cleanup:sealed-secrets:
    desc: |
      â„¹ï¸ Description:
        Removes sealed secrets files from the environment directory

      ğŸ”§ Variables:
        - TASK_DEVSECOPS_TEST_KUBECONFIG_DIR: Environment directory containing sealed secrets
    status:
      - test ! -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR}}/sealed-secrets.yaml
      - test ! -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR}}/.secrets.hash
    cmds:
      - cmd: echo "ğŸ”„ Starting sealed secrets cleanup"
        silent: true
      - rm -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR}}/sealed-secrets.yaml
      - rm -f {{.TASK_DEVSECOPS_TEST_KUBECONFIG_DIR}}/.secrets.hash
      - cmd: echo "ğŸ‰ Sealed secrets cleanup completed successfully"
        silent: true

  cleanup:helm:
    desc: |
      â„¹ï¸ Description:
        Removes downloaded Helm chart archives (*.tgz files)

      ğŸ”§ Variables:
        None - Removes all .tgz files from iac/helm directory
    status:
      - test -z "$(find iac/helm -name '*.tgz' 2>/dev/null)"
    cmds:
      - cmd: echo "ğŸ”„ Starting Helm chart cleanup"
        silent: true
      - rm -f iac/helm/**/*.tgz
      - cmd: echo "ğŸ‰ Helm chart cleanup completed successfully"
        silent: true

  syntax:
    desc: Perform syntax checks and linting
    cmds:
      - cmd: echo "ğŸ”„ Starting syntax phase"
        silent: true
      - task: :helm:lint
      - task: :ansible:syntax-check
        vars: { TASK_ANSIBLE_PLAYBOOK_DIR: "tests/infra/kube/ansible" }
      - cmd: echo "ğŸ‰ Syntax phase completed successfully"
        silent: true

  create:
    desc: |
      â„¹ï¸ Description:
        Creates and verifies the test infrastructure

      ğŸ”„ Execution:
        1. Creates k3d cluster
        2. Verifies all components are running
    cmds:
      - cmd: echo "ğŸ”„ Starting create phase"
        silent: true
      - task: :k3d:create:ensure:kubeconfig
      - task: :k3d:create:cluster
      - task: :k3d:create:cluster:verify
      - cmd: echo "ğŸ‰ Create phase completed successfully"
        silent: true

  prepare:
    desc: |
      â„¹ï¸ Description:
        Prepares the test infrastructure with required components
    cmds:
      - cmd: echo "ğŸ”„ Starting prepare phase"
        silent: true
      - task: :devsecops:deploy:bootstrap
      - cmd: echo "ğŸ‰ Prepare phase completed successfully"
        silent: true

  check-testing-environment:
    internal: true
    desc: Check if any of the KUBECONFIG variables contain "testing" and run TDD tests if so
    status:
      - test -v ENV && test -n "$ENV"
    cmds:
      - cmd: echo "ğŸ”„ Starting check-testing-environment phase"
        silent: true
      - task: dependency
      - task: create
      - cmd: echo "ğŸ‰ Check-testing-environment phase completed successfully"
        silent: true

  side_effect:
    desc: |
      â„¹ï¸ Description:
        Simulates side effects to test system resilience in the following order:
        1. Executes Ansible playbooks that disrupt normal operation
        2. Waits for automatic recovery mechanisms to engage
    cmds:
      - cmd: echo "ğŸ”„ Starting side effect simulation phase"
        silent: true
      - task: side_effect:ansible
      - cmd: echo "ğŸ‰ Side effect simulation phase completed successfully"
        silent: true

  side_effect:ansible:
    desc: |
      â„¹ï¸ Description:
        Executes infrastructure disruption playbooks

      ğŸ”§ Variables:
        - TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV: Path to Ansible virtual environment
    cmds:
      - cmd: echo "ğŸ”„ Starting ansible side effect disruption"
        silent: true
      - |
        find tests/infra/kube/ansible/side_effects -type f \( -name "*.yml" -o -name "*.yaml" \) | while read playbook; do
          echo "âš ï¸ Executing side effect playbook: $playbook"
          {{.TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV}}/bin/ansible-playbook "$playbook"
        done
      - cmd: echo "ğŸ‰ Ansible side effect disruption completed successfully"
        silent: true

  verify:
    desc: |
      â„¹ï¸ Description:
        Performs verification operations in the following order:
        1. Executes Ansible verification playbooks
    cmds:
      - cmd: echo "ğŸ”„ Starting verification phase"
        silent: true
      - task: verify:ansible
      - cmd: echo "ğŸ‰ Verification phase completed successfully"
        silent: true

  verify:ansible:
    desc: |
      â„¹ï¸ Description:
        Executes infrastructure verification playbooks

      ğŸ”§ Variables:
        - TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV: Path to Ansible virtual environment
    cmds:
      - cmd: echo "ğŸ”„ Starting ansible verification"
        silent: true
      - |
        find tests/infra/kube/ansible/verify -type f \( -name "*.yml" -o -name "*.yaml" \) | while read playbook; do
          echo "ğŸ” Executing verification playbook: $playbook"
          {{.TASK_DEVSECOPS_TEST_ANSIBLE_VIRTUALENV}}/bin/ansible-playbook "$playbook"
        done
      - cmd: echo "ğŸ‰ Ansible verification completed successfully"
        silent: true

  validate:resilience:
    desc: |
      â„¹ï¸ Description:
        Tests and validates infrastructure resilience by simulating disruptions
        and verifying recovery mechanisms
    cmds:
      - cmd: echo "ğŸ”„ Starting resilience validation phase"
        silent: true
      - task: side_effect
      - task: verify
      - cmd: echo "ğŸ‰ Resilience validation phase completed successfully"
        silent: true
