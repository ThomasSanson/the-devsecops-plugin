---
version: "3"

vars:
  TASK_DEVSECOPS_TEST_ENABLED: '{{.TASK_DEVSECOPS_TEST_ENABLED | default "true"}}'
  TASK_DEVSECOPS_TEST_STEPS_FULL:
    - test:infra:kube:dependency
    - test:infra:kube:destroy
    - test:infra:kube:cleanup
    - test:infra:kube:syntax
    - test:infra:kube:create
    - test:infra:kube:prepare
    - test:infra:kube:converge
    - test:infra:kube:idempotence
    - test:infra:kube:side_effect
    - test:infra:kube:verify
    - project:test
    - test:infra:kube:destroy
    - test:infra:kube:cleanup
  TASK_DEVSECOPS_TEST_STEPS_TDD:
    - test:infra:kube:dependency
    - test:infra:kube:syntax
    - test:infra:kube:create
    - test:infra:kube:prepare
    - test:infra:kube:converge
    - test:infra:kube:verify
    - project:test:tdd

tasks:
  default:
    desc: Run all tests tasks
    status:
      - test "{{.TASK_DEVSECOPS_TEST_ENABLED}}" = "false"
    cmds:
      - for: { var: TASK_DEVSECOPS_TEST_STEPS_FULL }
        task: ":{{.ITEM}}"

  tdd:
    desc: Run all tdd tests tasks
    status:
      - test "{{.TASK_DEVSECOPS_TEST_ENABLED}}" = "false"
    cmds:
      - for: { var: TASK_DEVSECOPS_TEST_STEPS_TDD }
        task: ":{{.ITEM}}"

  reset:
    desc: Reset infra
    status:
      - test "{{.TASK_DEVSECOPS_TEST_ENABLED}}" = "false"
    cmds:
      - task: :test:infra:kube:destroy
      - task: :test:infra:kube:cleanup
