---
version: "3"

vars:
  TASK_COPIER_ENABLED: '{{.TASK_COPIER_ENABLED | default "true"}}'
  TASK_COPIER_VIRTUALENV: '{{.TASK_COPIER_VIRTUALENV | default "./venv/copier"}}'
  TASK_COPIER_COMMAND: '{{.TASK_COPIER_COMMAND | default "./venv/copier/bin/copier"}}'
  TASK_COPIER_PYTHON_VERSION_FILE: '{{.TASK_COPIER_PYTHON_VERSION_FILE | default ".config/python/.python-version"}}'
  TASK_COPIER_REQUIREMENTS_FILE: '{{.TASK_COPIER_REQUIREMENTS_FILE | default ".config/copier/requirements.txt"}}'
  TASK_COPIER_CLI_OPTS: '{{.TASK_COPIER_CLI_OPTS | default ""}}'

tasks:
  install:
    desc: |
      â„¹ï¸ Description:
        Configures Copier and its dependencies within a controlled virtual environment.

      ğŸ”§ Variables:
        - TASK_COPIER_PYTHON_VERSION_FILE: Path to the Python version file
          Default: ".config/python/.python-version"
        - TASK_COPIER_REQUIREMENTS_FILE: Path to the requirements file
          Default: ".config/copier/requirements.txt"
        - TASK_COPIER_VIRTUALENV: Location of the virtual environment
          Default: "./venv/copier"

      ğŸ” Preconditions:
        - Python must be installed
        - Python version file must exist

      ğŸ”„ Execution:
        Creates a virtual environment and installs Copier with dependencies

      ğŸ“ Note:
        Ensure Python version file contains a version compatible with Copier
    preconditions:
      - sh: command -v python3 >/dev/null 2>&1
        msg: "âŒ Error: Python is not installed. Please install Python before proceeding."
      - sh: test -f {{.TASK_COPIER_PYTHON_VERSION_FILE}}
        msg: |
          âŒ Error: missing file {{.TASK_COPIER_PYTHON_VERSION_FILE}}.
          Please create it with the content "3.11"
    status:
      - |
        {{.TASK_COPIER_COMMAND}} --version | grep -q $(awk -F '==' '{print $2}' {{.TASK_COPIER_REQUIREMENTS_FILE}})
    cmds:
      - cmd: echo "ğŸ”„ Setting up Copier virtual environment"
        silent: true
      - defer: { task: cleanup }
      - python$(cut -d '=' -f 2 {{.TASK_COPIER_PYTHON_VERSION_FILE}}) -m venv {{.TASK_COPIER_VIRTUALENV}}
      - "{{.TASK_COPIER_VIRTUALENV}}/bin/pip install -r {{.TASK_COPIER_REQUIREMENTS_FILE}}"
      - cmd: echo 'ğŸ‰ Copier and dependencies installed successfully.'
        silent: true

  default:
    deps: [install]
    desc: |
      â„¹ï¸ Description:
        Run Copier with specified options.

      ğŸ”§ Variables:
        - TASK_COPIER_COMMAND: Command to run Copier
          Default: "./venv/copier/bin/copier"
        - TASK_COPIER_CLI_OPTS: Additional command line options
          Default: ""

      ğŸ” Preconditions:
        - The 'install' task must be completed

      ğŸ”„ Execution:
        Runs Copier with the provided arguments

      ğŸ“ Note:
        Use CLI_ARGS to pass additional arguments to Copier
    cmds:
      - cmd: echo "ğŸ”„ Running Copier with specified options"
        silent: true
      - "{{.TASK_COPIER_COMMAND}} {{.TASK_COPIER_CLI_OPTS}} {{.CLI_ARGS}}"
      - cmd: echo 'ğŸ‰ Copier run completed successfully.'
        silent: true

  cleanup:
    internal: true
    desc: |
      â„¹ï¸ Description:
        Cleans up temporary files created during installation.

      ğŸ”§ Variables: None

      ğŸ” Preconditions: None

      ğŸ”„ Execution:
        Removes temporary installation files.

      ğŸ“ Note:
        This task is internal and automatically called via defer.
    cmds:
      - cmd: echo "ğŸ”„ Cleaning up temporary files"
        silent: true
      - rm -rf {{.TASK_COPIER_VIRTUALENV}}/*-cache/
      - cmd: echo 'ğŸ‰ Temporary files have been cleaned up.'
        silent: true
