---
version: "3"

vars:
  TASK_ANSIBLE_ENABLED: '{{.TASK_ANSIBLE_ENABLED | default "true"}}'
  TASK_ANSIBLE_CONFIG_FULL_PATH: '{{.TASK_ANSIBLE_CONFIG_FULL_PATH | default ".config/ansible/ansible.cfg"}}'
  TASK_ANSIBLE_CLI_OPTS: '{{.TASK_ANSIBLE_CLI_OPTS | default ""}}'
  TASK_ANSIBLE_CLI_CHECK_OPTS: '{{.TASK_ANSIBLE_CLI_CHECK_OPTS | default "--check"}}'
  TASK_ANSIBLE_REQUIREMENTS_FILE: '{{.TASK_ANSIBLE_REQUIREMENTS_FILE | default ".config/ansible/requirements.txt"}}'
  TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE: '{{.TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE | default "tests/infra/kube/ansible/requirements.yml"}}'
  TASK_ANSIBLE_PLAYBOOK_DIR: '{{.TASK_ANSIBLE_PLAYBOOK_DIR | default ""}}'
  TASK_ANSIBLE_PYTHON_VERSION_PATH: '{{.TASK_ANSIBLE_PYTHON_VERSION_PATH | default ".config/python/.python-version"}}'
  TASK_ANSIBLE_PYTHON_VERSION:
    sh: |
      if [ -n "${TASK_ANSIBLE_PYTHON_VERSION:-}" ]; then
        echo "${TASK_ANSIBLE_PYTHON_VERSION}"
      else
        cat {{.TASK_ANSIBLE_PYTHON_VERSION_PATH}}
      fi
  TASK_ANSIBLE_VERSION:
    sh: |
      if [ -n "${TASK_ANSIBLE_VERSION:-}" ]; then
        echo "${TASK_ANSIBLE_VERSION}"
      else
        cat {{.TASK_ANSIBLE_REQUIREMENTS_FILE}}
      fi
  TASK_ANSIBLE_COMMAND:
    sh: |
      if [ -n "${TASK_ANSIBLE_COMMAND:-}" ]; then
        echo "${TASK_ANSIBLE_COMMAND}"
      else
        echo "uvx --python {{.TASK_ANSIBLE_PYTHON_VERSION}} --from {{.TASK_ANSIBLE_VERSION}}"
      fi

tasks:
  default:
    interactive: true
    desc: Run Ansible with default configuration.
    summary: |
      ‚ÑπÔ∏è Description:
        Executes Ansible with the default configuration to display version and settings.

      üîß Variables:
        - TASK_ANSIBLE_COMMAND: Command to run ansible.
        - TASK_ANSIBLE_CONFIG_FULL_PATH: Path to the ansible configuration file. Default: ".config/ansible/ansible.cfg"
        - TASK_ANSIBLE_CLI_OPTS: Command line options for ansible. Default: ""

      üîê Preconditions:
        - The 'install' task must have been successfully executed.
        - An ansible configuration file must exist at the specified location.

      üîÑ Execution:
        Runs ansible with the specified options and configuration to display version information.

      üìù Note:
        This task should be executed to verify ansible installation and configuration.
    cmds:
      - cmd: echo "üîÑ Starting default task"
        silent: true
      - |
        {{.TASK_ANSIBLE_COMMAND}} ansible --version && \
        echo "Ansible Configuration:" && \
        echo "- Config File: {{.TASK_ANSIBLE_CONFIG_FULL_PATH}}"
      - cmd: echo 'üéâ Default task completed successfully.'
        silent: true

  galaxy:collection:install:
    desc: Install Ansible Galaxy collections from requirements file.
    summary: |
      ‚ÑπÔ∏è Description:
        Installs Ansible collections specified in the requirements file within the virtual environment.

      üîß Variables:
        - TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE: Path to the collections requirements file.
          Default: "tests/infra/kube/requirements.yml"
          Example content:
            ```yaml
            ---
            collections:
              - name: kubernetes.core
                version: "5.1.0"
            ```

      üîê Preconditions:
        - The 'install' task must have been successfully executed.
        - A collections requirements file must exist at the specified location.
        - An active internet connection is required to download collections.

      üîÑ Execution:
        Installs all specified collections using ansible-galaxy collection install command.

      üìù Note:
        This task should be executed after the base Ansible installation to ensure all required collections are available.
    preconditions:
      - sh: test -f {{.TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE}}
        msg: |
          ‚ùå Error: Missing collections requirements file at {{.TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE}}.
          Please ensure the file exists and contains valid collection requirements.
    status:
      - |
        grep -E "name:|version:" {{.TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE}} | \
        awk 'NR%2 {name=$3; next} {gsub(/"/, "", $2); \
            cmd=sprintf("{{.TASK_ANSIBLE_COMMAND}} ansible-galaxy collection list | awk -v c=%s -v v=%s '\''BEGIN{f=0} $1==c && $2==v {f=1} END{exit !f}'\''", name, $2); \
            if (system(cmd) != 0) { \
                printf "‚ùå Error: Collection %s version %s is not installed\n", name, $2 > "/dev/stderr"; \
                exit 1 \
            } \
        }'
    cmds:
      - cmd: echo "üîÑ Installing Ansible collections"
        silent: true
      - |
        {{.TASK_ANSIBLE_COMMAND}} ansible-galaxy collection install -r {{.TASK_ANSIBLE_COLLECTIONS_REQUIREMENTS_FILE}}
      - cmd: echo 'üéâ Collections installed successfully.'
        silent: true

  syntax-check:
    desc: |
      ‚ÑπÔ∏è Description:
        Verifies the syntax of Ansible playbooks in a specified directory.

      üîß Variables:
        - TASK_ANSIBLE_COMMAND: Command to run ansible-playbook.
        - TASK_ANSIBLE_PLAYBOOK_DIR: Directory containing the playbooks to check.

      üîê Preconditions:
        - Ansible must be installed (via task 'install').
        - The playbook directory must exist.

      üîÑ Execution:
        - Iterates through all files in TASK_ANSIBLE_PLAYBOOK_DIR.
        - Runs ansible-playbook --syntax-check for each playbook.
    preconditions:
      - sh: test -d {{.TASK_ANSIBLE_PLAYBOOK_DIR}}
        msg: "‚ùå Playbook directory '{{.TASK_ANSIBLE_PLAYBOOK_DIR}}' not found or not specified via TASK_ANSIBLE_PLAYBOOK_DIR."
    cmds:
      - cmd: echo "üîÑ Checking playbook syntax"
        silent: true
      - |
        playbook_dir="{{.TASK_ANSIBLE_PLAYBOOK_DIR}}"
        echo "Checking syntax in directory: $playbook_dir"
        for playbook in "$playbook_dir"/**/*; do
          if [ -f "$playbook" ]; then
            echo "Checking syntax of $playbook"
            # DevSkim: ignore DS162092 # Required for Ansible syntax checking
            {{.TASK_ANSIBLE_COMMAND}} ansible-playbook --inventory localhost, --connection local --syntax-check "$playbook" # DevSkim: ignore DS162092
          fi
        done
      - cmd: echo 'üéâ Syntax check completed successfully.'
        silent: true
